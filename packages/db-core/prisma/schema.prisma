// C:\nexora\packages\db-core\prisma\schema.prisma
// NEXORA / db-core schema
// - Prisma 欄位 camelCase；DB 欄位 snake_case 用 @map 對應
// - ID 規則：VARCHAR(15) 由 DB DEFAULT gen_xxx_id() 產生
// - Prisma v7：連線資訊由 prisma.config.ts 管理，因此 datasource 不可寫 url

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// =======================================================
/// NX00 - User
/// Table: nx00_user
/// =======================================================
model Nx00User {
  id           String    @id @default(dbgenerated("gen_nx00_user_id()")) @db.VarChar(15)
  username     String    @unique @db.VarChar(50)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  displayName  String    @map("display_name") @db.VarChar(50)
  email        String?   @db.VarChar(100)
  phone        String?   @db.VarChar(20)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")

  createdAt    DateTime  @default(now()) @map("created_at")
  createdBy    String?   @map("created_by") @db.VarChar(15)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")
  updatedBy    String?   @map("updated_by") @db.VarChar(15)

  // self audit relations
  createdByUser Nx00User? @relation("Nx00UserCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00UserUpdatedBy", fields: [updatedBy], references: [id])

  createdUsers  Nx00User[] @relation("Nx00UserCreatedBy")
  updatedUsers  Nx00User[] @relation("Nx00UserUpdatedBy")

  // RBAC (UserRole / RoleView)
  userRoles Nx00UserRole[]

  // reverse relations (created/updated)
  rolesCreated       Nx00Role[]      @relation("Nx00RoleCreatedBy")
  rolesUpdated       Nx00Role[]      @relation("Nx00RoleUpdatedBy")
  viewsCreated       Nx00View[]      @relation("Nx00ViewCreatedBy")
  viewsUpdated       Nx00View[]      @relation("Nx00ViewUpdatedBy")
  roleViewsCreated   Nx00RoleView[]  @relation("Nx00RoleViewCreatedBy")
  roleViewsUpdated   Nx00RoleView[]  @relation("Nx00RoleViewUpdatedBy")

  partsCreated       Nx00Part[]      @relation("Nx00PartCreatedBy")
  partsUpdated       Nx00Part[]      @relation("Nx00PartUpdatedBy")
  brandsCreated      Nx00Brand[]     @relation("Nx00BrandCreatedBy")
  brandsUpdated      Nx00Brand[]     @relation("Nx00BrandUpdatedBy")
  warehousesCreated  Nx00Warehouse[] @relation("Nx00WarehouseCreatedBy")
  warehousesUpdated  Nx00Warehouse[] @relation("Nx00WarehouseUpdatedBy")
  locationsCreated   Nx00Location[]  @relation("Nx00LocationCreatedBy")
  locationsUpdated   Nx00Location[]  @relation("Nx00LocationUpdatedBy")
  partnersCreated    Nx00Partner[]   @relation("Nx00PartnerCreatedBy")
  partnersUpdated    Nx00Partner[]   @relation("Nx00PartnerUpdatedBy")

  // assignment/grant/revoke actors
  userRolesAssigned   Nx00UserRole[]  @relation("Nx00UserRoleAssignedBy")
  roleViewsGranted    Nx00RoleView[]  @relation("Nx00RoleViewGrantedBy")
  roleViewsRevoked    Nx00RoleView[]  @relation("Nx00RoleViewRevokedBy")

  // audit log actor
  auditLogs Nx00AuditLog[]

  @@map("nx00_user")
}

/// =======================================================
/// NX00 - Role
/// Table: nx00_role
/// =======================================================
model Nx00Role {
  id          String   @id @default(dbgenerated("gen_nx00_role_id()")) @db.VarChar(15)
  code        String   @unique @db.VarChar(30)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  isSystem    Boolean  @default(false) @map("is_system")
  isActive    Boolean  @default(true) @map("is_active")
  sortNo      Int      @default(0) @map("sort_no")

  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String?  @map("created_by") @db.VarChar(15)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00RoleCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00RoleUpdatedBy", fields: [updatedBy], references: [id])

  userRoles Nx00UserRole[]
  roleViews Nx00RoleView[]

  @@map("nx00_role")
}

/// =======================================================
/// NX00 - UserRole
/// Table: nx00_user_role
/// =======================================================
model Nx00UserRole {
  id         String    @id @default(dbgenerated("gen_nx00_user_role_id()")) @db.VarChar(15)
  userId     String    @map("user_id") @db.VarChar(15)
  roleId     String    @map("role_id") @db.VarChar(15)

  isPrimary  Boolean   @default(false) @map("is_primary")
  assignedAt DateTime  @default(now()) @map("assigned_at")
  assignedBy String?   @map("assigned_by") @db.VarChar(15)
  revokedAt  DateTime? @map("revoked_at")
  isActive   Boolean   @default(true) @map("is_active")

  user          Nx00User @relation(fields: [userId], references: [id])
  role          Nx00Role @relation(fields: [roleId], references: [id])
  assignedByUser Nx00User? @relation("Nx00UserRoleAssignedBy", fields: [assignedBy], references: [id])

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@index([isActive])
  @@map("nx00_user_role")
}

/// =======================================================
/// NX00 - View
/// Table: nx00_view
/// =======================================================
model Nx00View {
  id         String   @id @default(dbgenerated("gen_nx00_view_id()")) @db.VarChar(15)
  code       String   @unique @db.VarChar(50)
  name       String   @db.VarChar(100)
  moduleCode String   @map("module_code") @db.VarChar(10)
  path       String   @db.VarChar(200)
  sortNo     Int      @default(0) @map("sort_no")
  isActive   Boolean  @default(true) @map("is_active")

  createdAt  DateTime @default(now()) @map("created_at")
  createdBy  String?  @map("created_by") @db.VarChar(15)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy  String?  @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00ViewCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00ViewUpdatedBy", fields: [updatedBy], references: [id])

  roleViews Nx00RoleView[]

  @@index([moduleCode])
  @@index([isActive])
  @@map("nx00_view")
}

/// =======================================================
/// NX00 - RoleView
/// Table: nx00_role_view
/// =======================================================
model Nx00RoleView {
  id        String   @id @default(dbgenerated("gen_nx00_role_view_id()")) @db.VarChar(15)
  roleId    String   @map("role_id") @db.VarChar(15)
  viewId    String   @map("view_id") @db.VarChar(15)

  canRead   Boolean  @default(true)  @map("can_read")
  canCreate Boolean  @default(false) @map("can_create")
  canUpdate Boolean  @default(false) @map("can_update")
  canDelete Boolean  @default(false) @map("can_delete")
  canExport Boolean  @default(false) @map("can_export")

  isActive  Boolean  @default(true) @map("is_active")

  grantedAt DateTime @default(now()) @map("granted_at")
  grantedBy String?  @map("granted_by") @db.VarChar(15)
  revokedAt DateTime? @map("revoked_at")
  revokedBy String?  @map("revoked_by") @db.VarChar(15)

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.VarChar(15)

  role Nx00Role @relation(fields: [roleId], references: [id])
  view Nx00View @relation(fields: [viewId], references: [id])

  grantedByUser Nx00User? @relation("Nx00RoleViewGrantedBy", fields: [grantedBy], references: [id])
  revokedByUser Nx00User? @relation("Nx00RoleViewRevokedBy", fields: [revokedBy], references: [id])

  createdByUser Nx00User? @relation("Nx00RoleViewCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00RoleViewUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([roleId, viewId])
  @@index([roleId])
  @@index([viewId])
  @@index([isActive])
  @@map("nx00_role_view")
}

/// =======================================================
/// NX00 - Part
/// Table: nx00_part
/// =======================================================
model Nx00Part {
  id       String  @id @default(dbgenerated("gen_nx00_part_id()")) @db.VarChar(15)
  code     String  @unique @db.VarChar(50)
  name     String  @db.VarChar(200)
  brandId  String? @map("brand_id") @db.VarChar(15)
  spec     String? @db.VarChar(200)
  uom      String  @default("pcs") @db.VarChar(10)
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.VarChar(15)

  brand Nx00Brand? @relation(fields: [brandId], references: [id])

  createdByUser Nx00User? @relation("Nx00PartCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00PartUpdatedBy", fields: [updatedBy], references: [id])

  @@index([brandId])
  @@index([isActive])
  @@map("nx00_part")
}

/// =======================================================
/// NX00 - Brand
/// Table: nx00_brand
/// =======================================================
model Nx00Brand {
  id            String  @id @default(dbgenerated("gen_nx00_brand_id()")) @db.VarChar(15)
  code          String  @unique @db.VarChar(30)
  name          String  @db.VarChar(100)
  originCountry String? @map("origin_country") @db.VarChar(50)
  remark        String? @db.VarChar(200)
  isActive      Boolean @default(true) @map("is_active")
  sortNo        Int     @default(0) @map("sort_no")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00BrandCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00BrandUpdatedBy", fields: [updatedBy], references: [id])

  parts Nx00Part[]

  @@index([isActive])
  @@map("nx00_brand")
}

/// =======================================================
/// NX00 - Warehouse
/// Table: nx00_warehouse
/// =======================================================
model Nx00Warehouse {
  id       String  @id @default(dbgenerated("gen_nx00_warehouse_id()")) @db.VarChar(15)
  code     String  @unique @db.VarChar(10)
  name     String  @db.VarChar(100)
  remark   String? @db.VarChar(200)
  sortNo   Int     @default(0) @map("sort_no")
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00WarehouseCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00WarehouseUpdatedBy", fields: [updatedBy], references: [id])

  locations Nx00Location[]

  @@index([isActive])
  @@map("nx00_warehouse")
}

/// =======================================================
/// NX00 - Location
/// Table: nx00_location
/// =======================================================
model Nx00Location {
  id          String  @id @default(dbgenerated("gen_nx00_location_id()")) @db.VarChar(15)
  warehouseId String  @map("warehouse_id") @db.VarChar(15)
  code        String  @db.VarChar(30)
  name        String? @db.VarChar(100)
  zone        String? @db.VarChar(20)
  rack        String? @db.VarChar(20)
  levelNo     Int?    @map("level_no")
  binNo       String? @map("bin_no") @db.VarChar(20)
  remark      String? @db.VarChar(200)
  sortNo      Int     @default(0) @map("sort_no")
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.VarChar(15)

  warehouse Nx00Warehouse @relation(fields: [warehouseId], references: [id])

  createdByUser Nx00User? @relation("Nx00LocationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00LocationUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@index([isActive])
  @@map("nx00_location")
}

/// =======================================================
/// NX00 - Partner
/// Table: nx00_partner
/// =======================================================
model Nx00Partner {
  id          String  @id @default(dbgenerated("gen_nx00_partner_id()")) @db.VarChar(15)
  code        String  @unique @db.VarChar(30)
  name        String  @db.VarChar(120)
  partnerType String  @default("BOTH") @map("partner_type") @db.VarChar(10)
  contactName String? @map("contact_name") @db.VarChar(50)
  phone       String? @db.VarChar(30)
  mobile      String? @db.VarChar(30)
  email       String? @db.VarChar(100)
  address     String? @db.VarChar(200)
  remark      String? @db.VarChar(200)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00PartnerCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00PartnerUpdatedBy", fields: [updatedBy], references: [id])

  @@index([isActive])
  @@index([partnerType])
  @@map("nx00_partner")
}

/// =======================================================
/// NX00 - AuditLog
/// Table: nx00_audit_log
/// =======================================================
model Nx00AuditLog {
  id          String   @id @default(dbgenerated("gen_nx00_audit_log_id()")) @db.VarChar(15)
  occurredAt  DateTime @default(now()) @map("occurred_at")
  actorUserId String   @map("actor_user_id") @db.VarChar(15)

  moduleCode  String   @map("module_code") @db.VarChar(10)
  action      String   @db.VarChar(20)
  entityTable String   @map("entity_table") @db.VarChar(50)

  entityId    String?  @map("entity_id") @db.VarChar(20)
  entityCode  String?  @map("entity_code") @db.VarChar(50)
  summary     String?  @db.VarChar(200)

  beforeData  Json?    @map("before_data")
  afterData   Json?    @map("after_data")

  ipAddr      String?  @map("ip_addr") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(200)

  actorUser Nx00User @relation(fields: [actorUserId], references: [id])

  @@index([occurredAt])
  @@index([actorUserId])
  @@index([moduleCode])
  @@index([entityTable])
  @@map("nx00_audit_log")
}