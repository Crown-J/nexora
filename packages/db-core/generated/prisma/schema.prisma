// C:\nexora\packages\db-core\prisma\schema.prisma
// NEXORA / db-core schema
// - Prisma 欄位 camelCase；DB 欄位 snake_case 用 @map 對應
// - ID 規則：VARCHAR(15) 由 DB DEFAULT gen_xxx_id() 產生
// - Prisma v7：連線資訊由 prisma.config.ts 管理，因此 datasource 不可寫 url

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// =======================================================
/// NX00 - User
/// Table: nx00_user
/// =======================================================
model Nx00User {
  id           String    @id @default(dbgenerated("gen_nx00_user_id()")) @db.VarChar(15)
  username     String    @unique @db.VarChar(50)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  displayName  String    @map("display_name") @db.VarChar(50)
  email        String?   @db.VarChar(100)
  phone        String?   @db.VarChar(30)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  statusCode   String    @default("A") @map("uu_sta") @db.VarChar(10)
  remark       String?   @map("uu_rmk")

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  // self audit relations
  createdByUser Nx00User? @relation("Nx00UserCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00UserUpdatedBy", fields: [updatedBy], references: [id])

  createdUsers Nx00User[] @relation("Nx00UserCreatedBy")
  updatedUsers Nx00User[] @relation("Nx00UserUpdatedBy")

  // RBAC
  userRoles Nx00UserRole[]

  // audit reverse relations
  rolesCreated     Nx00Role[]     @relation("Nx00RoleCreatedBy")
  rolesUpdated     Nx00Role[]     @relation("Nx00RoleUpdatedBy")
  userRolesCreated Nx00UserRole[] @relation("Nx00UserRoleCreatedBy")

  permissionsCreated Nx00Permission[]     @relation("Nx00PermissionCreatedBy")
  permissionsUpdated Nx00Permission[]     @relation("Nx00PermissionUpdatedBy")
  rolePermsCreated   Nx00RolePermission[] @relation("Nx00RolePermissionCreatedBy")

  brandsCreated         Nx00Brand[]         @relation("Nx00BrandCreatedBy")
  brandsUpdated         Nx00Brand[]         @relation("Nx00BrandUpdatedBy")
  functionGroupsCreated Nx00FunctionGroup[] @relation("Nx00FunctionGroupCreatedBy")
  functionGroupsUpdated Nx00FunctionGroup[] @relation("Nx00FunctionGroupUpdatedBy")
  partStatusesCreated   Nx00PartStatus[]    @relation("Nx00PartStatusCreatedBy")
  partStatusesUpdated   Nx00PartStatus[]    @relation("Nx00PartStatusUpdatedBy")
  partsCreated          Nx00Part[]          @relation("Nx00PartCreatedBy")
  partsUpdated          Nx00Part[]          @relation("Nx00PartUpdatedBy")

  warehousesCreated Nx00Warehouse[] @relation("Nx00WarehouseCreatedBy")
  warehousesUpdated Nx00Warehouse[] @relation("Nx00WarehouseUpdatedBy")
  locationsCreated  Nx00Location[]  @relation("Nx00LocationCreatedBy")
  locationsUpdated  Nx00Location[]  @relation("Nx00LocationUpdatedBy")

  partnersCreated Nx00BusinessPartner[] @relation("Nx00BusinessPartnerCreatedBy")
  partnersUpdated Nx00BusinessPartner[] @relation("Nx00BusinessPartnerUpdatedBy")

  auditLogs Nx00AuditLog[]

  @@map("nx00_user")
}

/// =======================================================
/// NX00 - Role
/// Table: nx00_role
/// =======================================================
model Nx00Role {
  id          String  @id @default(dbgenerated("gen_nx00_role_id()")) @db.VarChar(15)
  code        String  @unique @db.VarChar(30)
  name        String  @db.VarChar(50)
  description String? @db.VarChar(255)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00RoleCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00RoleUpdatedBy", fields: [updatedBy], references: [id])

  userRoles Nx00UserRole[]
  rolePerms Nx00RolePermission[]

  @@map("nx00_role")
}

/// =======================================================
/// NX00 - UserRole
/// Table: nx00_user_role
/// =======================================================
model Nx00UserRole {
  id        String   @id @default(dbgenerated("gen_nx00_user_role_id()")) @db.VarChar(15)
  userId    String   @map("user_id") @db.VarChar(15)
  roleId    String   @map("role_id") @db.VarChar(15)
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") @db.VarChar(15)

  user          Nx00User  @relation(fields: [userId], references: [id])
  role          Nx00Role  @relation(fields: [roleId], references: [id])
  createdByUser Nx00User? @relation("Nx00UserRoleCreatedBy", fields: [createdBy], references: [id])

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("nx00_user_role")
}

/// =======================================================
/// NX00 - Permission
/// Table: nx00_permission
/// =======================================================
model Nx00Permission {
  id         String  @id @default(dbgenerated("gen_nx00_permission_id()")) @db.VarChar(15)
  code       String  @unique @db.VarChar(80)
  name       String  @db.VarChar(80)
  moduleCode String  @map("module_code") @db.VarChar(10)
  action     String  @db.VarChar(20)
  isActive   Boolean @default(true) @map("is_active")
  sortNo     Int?    @map("sort_no")

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00PermissionCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00PermissionUpdatedBy", fields: [updatedBy], references: [id])

  rolePerms Nx00RolePermission[]

  @@index([isActive])
  @@index([moduleCode])
  @@map("nx00_permission")
}

/// =======================================================
/// NX00 - RolePermission
/// Table: nx00_role_permission
/// =======================================================
model Nx00RolePermission {
  id           String   @id @default(dbgenerated("gen_nx00_role_permission_id()")) @db.VarChar(15)
  roleId       String   @map("role_id") @db.VarChar(15)
  permissionId String   @map("permission_id") @db.VarChar(15)
  createdAt    DateTime @default(now()) @map("created_at")
  createdBy    String?  @map("created_by") @db.VarChar(15)

  role          Nx00Role       @relation(fields: [roleId], references: [id])
  permission    Nx00Permission @relation(fields: [permissionId], references: [id])
  createdByUser Nx00User?      @relation("Nx00RolePermissionCreatedBy", fields: [createdBy], references: [id])

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("nx00_role_permission")
}

/// =======================================================
/// NX00 - Brand
/// Table: nx00_brand
/// =======================================================
model Nx00Brand {
  id       String  @id @default(dbgenerated("gen_nx00_brand_id()")) @db.VarChar(15)
  code     String  @unique @db.VarChar(30)
  name     String  @db.VarChar(50)
  nameEn   String? @map("name_en") @db.VarChar(50)
  isActive Boolean @default(true) @map("is_active")
  remark   String? @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00BrandCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00BrandUpdatedBy", fields: [updatedBy], references: [id])

  parts Nx00Part[]

  @@index([isActive])
  @@map("nx00_brand")
}

/// =======================================================
/// NX00 - FunctionGroup
/// Table: nx00_function_group
/// =======================================================
model Nx00FunctionGroup {
  id          String  @id @default(dbgenerated("gen_nx00_function_group_id()")) @db.VarChar(15)
  code        String  @unique @db.VarChar(30)
  name        String  @db.VarChar(50)
  description String? @db.VarChar(255)
  isActive    Boolean @default(true) @map("is_active")
  sortNo      Int?    @map("sort_no")

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00FunctionGroupCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00FunctionGroupUpdatedBy", fields: [updatedBy], references: [id])

  parts Nx00Part[]

  @@index([isActive])
  @@map("nx00_function_group")
}

/// =======================================================
/// NX00 - PartStatus
/// Table: nx00_part_status
/// =======================================================
model Nx00PartStatus {
  id          String  @id @default(dbgenerated("gen_nx00_part_status_id()")) @db.VarChar(15)
  code        String  @unique @db.VarChar(10)
  name        String  @db.VarChar(50)
  canSell     Boolean @default(true) @map("can_sell")
  canPurchase Boolean @default(true) @map("can_purchase")
  isActive    Boolean @default(true) @map("is_active")
  remark      String? @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00PartStatusCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00PartStatusUpdatedBy", fields: [updatedBy], references: [id])

  parts Nx00Part[]

  @@index([isActive])
  @@map("nx00_part_status")
}

/// =======================================================
/// NX00 - Part
/// Table: nx00_part
/// =======================================================
model Nx00Part {
  id              String  @id @default(dbgenerated("gen_nx00_part_id()")) @db.VarChar(15)
  partNo          String  @unique @map("part_no") @db.VarChar(50)
  oldPartNo       String? @map("old_part_no") @db.VarChar(50)
  displayNo       String? @map("display_no") @db.VarChar(50)
  nameZh          String  @map("name_zh") @db.VarChar(100)
  nameEn          String? @map("name_en") @db.VarChar(100)
  brandId         String  @map("brand_id") @db.VarChar(15)
  functionGroupId String? @map("function_group_id") @db.VarChar(15)
  statusId        String  @map("status_id") @db.VarChar(15)
  barcode         String? @db.VarChar(100)
  isActive        Boolean @default(true) @map("is_active")
  remark          String? @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  brand         Nx00Brand          @relation(fields: [brandId], references: [id])
  functionGroup Nx00FunctionGroup? @relation(fields: [functionGroupId], references: [id])
  status        Nx00PartStatus     @relation(fields: [statusId], references: [id])

  createdByUser Nx00User? @relation("Nx00PartCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00PartUpdatedBy", fields: [updatedBy], references: [id])

  @@index([brandId])
  @@index([functionGroupId])
  @@index([statusId])
  @@index([isActive])
  @@map("nx00_part")
}

/// =======================================================
/// NX00 - Warehouse
/// Table: nx00_warehouse
/// =======================================================
model Nx00Warehouse {
  id       String  @id @default(dbgenerated("gen_nx00_warehouse_id()")) @db.VarChar(15)
  code     String  @unique @db.VarChar(10)
  name     String  @db.VarChar(50)
  isActive Boolean @default(true) @map("is_active")
  remark   String? @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00WarehouseCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00WarehouseUpdatedBy", fields: [updatedBy], references: [id])

  locations Nx00Location[]

  @@index([isActive])
  @@map("nx00_warehouse")
}

/// =======================================================
/// NX00 - Location
/// Table: nx00_location
/// =======================================================
model Nx00Location {
  id          String  @id @default(dbgenerated("gen_nx00_location_id()")) @db.VarChar(15)
  warehouseId String  @map("warehouse_id") @db.VarChar(15)
  code        String  @unique @db.VarChar(10)
  name        String? @db.VarChar(50)
  isActive    Boolean @default(true) @map("is_active")
  remark      String? @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  warehouse Nx00Warehouse @relation(fields: [warehouseId], references: [id])

  createdByUser Nx00User? @relation("Nx00LocationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00LocationUpdatedBy", fields: [updatedBy], references: [id])

  @@index([warehouseId])
  @@index([isActive])
  @@map("nx00_location")
}

/// =======================================================
/// NX00 - BusinessPartner
/// Table: nx00_business_partner
/// =======================================================
model Nx00BusinessPartner {
  id      String  @id @default(dbgenerated("gen_nx00_business_partner_id()")) @db.VarChar(15)
  code    String  @unique @db.VarChar(10)
  name    String  @db.VarChar(50)
  taxId   String? @map("tax_id") @db.VarChar(20)
  phone   String? @db.VarChar(30)
  email   String? @db.VarChar(100)
  address String? @db.VarChar(255)

  isCustomer Boolean @default(false) @map("is_customer")
  isVendor   Boolean @default(false) @map("is_vendor")
  isActive   Boolean @default(true) @map("is_active")
  remark     String? @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.VarChar(15)
  updatedAt DateTime? @map("updated_at")
  updatedBy String?   @map("updated_by") @db.VarChar(15)

  createdByUser Nx00User? @relation("Nx00BusinessPartnerCreatedBy", fields: [createdBy], references: [id])
  updatedByUser Nx00User? @relation("Nx00BusinessPartnerUpdatedBy", fields: [updatedBy], references: [id])

  @@index([isActive])
  @@index([isCustomer])
  @@index([isVendor])
  @@map("nx00_business_partner")
}

/// =======================================================
/// NX00 - AuditLog
/// Table: nx00_audit_log
/// =======================================================
model Nx00AuditLog {
  id     String @id @default(dbgenerated("gen_nx00_audit_log_id()")) @db.VarChar(15)
  userId String @map("user_id") @db.VarChar(15)

  moduleCode String @map("module_code") @db.VarChar(10)
  action     String @db.VarChar(20)
  entity     String @db.VarChar(50)

  entityId  String? @map("entity_id") @db.VarChar(15)
  docNo     String? @map("doc_no") @db.VarChar(50)
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.VarChar(255)

  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")

  user Nx00User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([moduleCode])
  @@index([entity])
  @@index([createdAt])
  @@map("nx00_audit_log")
}
